@using HitechCraft.Common.Models.Enum
@using HitechCraft.DAL.Domain.Extentions
@model IEnumerable<HitechCraft.WebApplication.Models.PrivateMessageViewModel>

@if (Model != null && Model.Any())
{
    <div id="message-options">
        <div class="message-options">
            <h3>Выберите сообщение</h3>
        </div>
    </div>

    foreach (var message in Model)
    {
        <div onclick="javascript:LoadInboxMessageOptions(@message.Id);" class="message-box">
            <div class="message-player">
                <img src="@Url.Action("GetSkinImage", "Player", new {playerName = message.Players.First(x => x.PlayerType == PMPlayerType.Author).PlayerName})" id="skin-image@(message.Id)" class="avaSkin@(message.Id)" hidden="" />
            </div>
            <div class="message-content">
                <p class="message-title">
                    @message.Title
                    @if (message.Players.First(x => x.PlayerType == PMPlayerType.Recipient).MessageType == PMType.New)
                    {
                        <span class="alert alert-warning message-inbox-new" style="margin-top: 4px;" title="Новое сообщения!">New</span>
                    }
                </p>
                <p>@message.Text.Limit(120)...</p>
                <p class="message-player-sign">@message.Players.First(x => x.PlayerType == PMPlayerType.Author).PlayerName</p>
                <div class="clear"></div>
                <div class="message-footer">
                    <p>@message.TimeCreate</p>
                    <div class="clear"></div>
                </div>
            </div>
            <div class="clear"></div>
        </div>

        <script type="text/javascript">
            $(document).ready(function () {
                renderMCSkins('avaSkin@(message.Id)', 9);
            });
        </script>
    }
}
else
{
    <h3>Папка пуста</h3>
}

<script type="text/javascript">

    function GetNewMessagesCount() {
        $.get('@Url.Action("GetNewMessagesCount")',
            function (data) {
                if (parseInt(data) > 0) {
                    $('#new-messages').html('');
                    $('#new-messages').html(data);

                    $('#new-inbox-messages').html('');
                    $('#new-inbox-messages').html(data);
                } else {
                    $('#new-messages').css('display', 'none');
                    $('#new-inbox-messages').css('display', 'none');
                }
            });
    }

    function LoadInboxMessageOptions(id) {
        $.get('@Url.Action("GetMessageOptions")', { messageId: parseInt(id) },
        function (data) {
            $('#message-options').html('');
            $('#message-options').html(data);
        });
    }

    function LoadInboxMessage(id) {
        $.get('@Url.Action("GetInboxMessage")', { messageId: parseInt(id) },
        function (data) {
            if (data !== "NO") {
                GetNewMessagesCount();
                $('#inbox').html('');
                $('#inbox').html(data);
                $('#message-options').html('');
            } else {
                growlError("Это сообщение недоступно!");
            }
        });
    }

    function DeleteInboxMessage(id) {
        if (confirm("Вы действительно хотите удалить сообщение?")) {
            $.post('@Url.Action("DeleteMessage")', { messageId: parseInt(id) },
                function (data) {
                    if (data === "OK") {
                        GetNewMessagesCount();
                        LoadInbox();
                    } else {
                        growlError(data);
                    }
                });
        }
    }
</script>